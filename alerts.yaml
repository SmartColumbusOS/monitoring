serverFiles:
  alerts:
    groups:
      # Blackbox probe
      - name: Sites
        rules:
          - alert: SiteDown
            expr: probe_success == 0
            for: 2m
            labels:
              severity: error
            annotations:
              description: '{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 2 minutes.'
              summary: 'Instance {{ $labels.instance }} down'
      - name: K8S_Nodes
        rules:
          - alert: LowMemory
            expr: (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100) < 20
            for: 5m
            labels:
              severity: warning
            annotations:
              description: '{{ $labels.instance }} has {{ $value }} percent memory left.'
              summary: 'Low Memory on Instance {{ $labels.instance }}'
          - alert: LowDisk
            expr: (node_filesystem_avail_bytes{device=~"/dev/.*"} / node_filesystem_size_bytes{device=~"/dev/.*"} * 100) < 20
            for: 5m
            labels:
              severity: warning
            annotations:
              description: '{{ $labels.instance }} has {{ $value }} percent disk left.'
              summary: 'Low Disk on Instance {{ $labels.instance }}'
          - alert: LowClusterCPU
            expr: (cluster:capacity_cpu:sum - cluster:guarantees_cpu:sum) < 1
            labels:
              severity: warning
            annotations:
              description: 'Kubernetes cluster has {{ $value }} cores left. New deployments and cron jobs may fail to launch.'
              summary: 'Kubernetes cluster low on CPU cores'
          - alert: LowClusterMemory
            expr: (cluster:capacity_memory_bytes:sum - cluster:guarantees_memory_bytes:sum) < 1000000000 #1GB
            labels:
              severity: warning
            annotations:
              description: 'Kubernetes cluster has {{ $value | humanize }} memory left. New deployments and cron jobs may fail to launch.'
              summary: 'Kubernetes cluster has less than {{ 1000000000.0 | humanize }} memory available'
      - name: StreamingDataAggregator
        rules:
          - alert: CeavVehicleLocationsJobFailed
            expr: sum(rate(kube_job_status_failed{job_name=~"streaming-data-aggregator-ceav-vehicle-locations.*"}[2h])) > 0
            labels:
              severity: error
            annotations:
              description: 'Job StreamingDataAggregator-CeavVehicleLocations failed'
              summary: 'Job StreamingDataAggregator-CeavVehicleLocations failed'
          - alert: CeavRoutesJobFailed
            expr: sum(rate(kube_job_status_failed{job_name=~"streaming-data-aggregator-ceav-routes.*"}[2h])) > 0
            labels:
              severity: error
            annotations:
              description: 'Job StreamingDataAggregator-CeavRoutes failed'
              summary: 'Job StreamingDataAggregator-CeavRoutes failed'
          - alert: CeavRouteSegmentsJobFailed
            expr: sum(rate(kube_job_status_failed{job_name=~"streaming-data-aggregator-ceav-route-segments.*"}[2h])) > 0
            labels:
              severity: error
            annotations:
              description: 'Job StreamingDataAggregator-CeavRouteSegments failed'
              summary: 'Job StreamingDataAggregator-CeavRouteSegments failed'
          - alert: CeavShiftsJobFailed
            expr: sum(rate(kube_job_status_failed{job_name=~"streaming-data-aggregator-ceav-shifts.*"}[2h])) > 0
            labels:
              severity: error
            annotations:
              description: 'Job StreamingDataAggregator-CeavShifts failed'
              summary: 'Job StreamingDataAggregator-CeavShifts failed'
          - alert: CeavShiftSegmentsJobFailed
            expr: sum(rate(kube_job_status_failed{job_name=~"streaming-data-aggregator-ceav-shift-segments.*"}[2h])) > 0
            labels:
              severity: error
            annotations:
              description: 'Job StreamingDataAggregator-CeavShiftSegments failed'
              summary: 'Job StreamingDataAggregator-CeavShiftSegments failed'
          - alert: Errors
            expr: streaming_data_aggregator_errors{type!="kafka-parse"} > 0
            labels:
              severity: error
            annotations:
              description: 'Job {{ $labels.instance }} failed with error type {{ $labels.type }}.'
              summary: 'Job {{ $labels.job }} failed.'
