serverFiles:
  alerts:
    groups:
      # Blackbox probe
      - name: Sites
        rules:
          - alert: SiteDown
            expr: probe_success == 0
            for: 2m
            labels:
              severity: error
            annotations:
              description: '{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 2 minutes.'
              summary: 'Instance {{ $labels.instance }} down'
      - name: K8S_Nodes
        rules:
          - alert: LowMemory
            expr: (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100) < 20
            for: 5m
            labels:
              severity: warning
            annotations:
              description: '{{ $labels.instance }} has {{ $value }} percent memory left.'
              summary: 'Low Memory on Instance {{ $labels.instance }}'
          - alert: LowDisk
            expr: (node_filesystem_avail_bytes{device=~"/dev/.*"} / node_filesystem_size_bytes{device=~"/dev/.*"} * 100) < 15
            for: 5m
            labels:
              severity: warning
            annotations:
              description: '{{ $labels.instance }} has {{ $value }} percent disk left.'
              summary: 'Low Disk on Instance {{ $labels.instance }}'
          - alert: LowClusterCPU
            expr: (cluster:capacity_cpu:sum - cluster:guarantees_cpu:sum) < 1
            labels:
              severity: warning
            annotations:
              description: 'Kubernetes cluster has {{ $value }} cores left. New deployments and cron jobs may fail to launch.'
              summary: 'Kubernetes cluster low on CPU cores'
          - alert: LowClusterMemory
            expr: (cluster:capacity_memory_bytes:sum - cluster:guarantees_memory_bytes:sum) < 1000000000 #1GB
            labels:
              severity: warning
            annotations:
              description: 'Kubernetes cluster has {{ $value | humanize }} memory left. New deployments and cron jobs may fail to launch.'
              summary: 'Kubernetes cluster has less than {{ 1000000000.0 | humanize }} memory available'
          - alert: NotReady
            annotations:
              description: '{{ $labels.node }} is not ready'
              summary: 'Status not Ready on Node {{ $labels.node }}'
            expr: kube_node_status_condition{condition="Ready", status="true"} != 1
            labels:
              severity: error
      - name: tracer_alerts
        rules:
          - alert: MessageThroughput
            expr: sum(rate(kafka_topic_partition_current_offset{topic=~".*-00000000-7e77-4b1c-92a4-36e09db56173|streaming-persisted|scos__sample_streaming_dataset"}[5m])) by (topic) == 0
            labels:
              severity: error
            annotations:
              summary: '{{ $labels.topic }} has no input for at least 5 minutes'
      - name: joomla_backup
    rules:
      - alert: JoomlaBackupFailed
        expr: sum(rate(kube_job_status_failed{job_name=~"joomler-test.*"}[24h])) > 0
        labels:
          severity: error
        annotations:
          summary: 'Joomla Backup Failed'
          description: '{{ $labels.job_name }} has failed'
      - alert: JoomlaBackupNotCompleted
        expr: kube_cronjob_status_active{cronjob="joomler-test"} > 0 and time() - kube_cronjob_status_last_schedule_time{cronjob="joomler-test"} > 1800
        labels:
          severity: error
        annotations:
          summary: 'Joomla Backup Hung'
          description: '{{ $labels.cronjob }} has been running for over 2 minutes'
      - alert: JoomlaBackupOverdue
        expr: time() - max(kube_job_status_completion_time{job_name=~"joomler-test.*"}) > 86400
        labels:
          severity: error
        annotations:
          summary: 'Joomla Backup Overdue'
          description: 'Backup has not run in over 24 hours - last backup: {{ $labels.job_name }}'
